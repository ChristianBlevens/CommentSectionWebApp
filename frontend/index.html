<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comment Section</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <link href="css/index.css" rel="stylesheet">
    <link href="css/comment-highlight.css" rel="stylesheet">
    <link href="css/users.css" rel="stylesheet">
    <link href="css/moderators.css" rel="stylesheet">
    <link href="css/reports.css" rel="stylesheet">
    <!-- Load core libraries first -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <!-- Load app scripts before Alpine.js -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/ban-handler.js"></script>
    <script src="js/markdown.js"></script>
    <script src="js/comment.js"></script>
    <script src="js/comment-app.js"></script>
    <script src="js/reports-app.js"></script>
    <script src="js/moderators-app.js"></script>
    <script src="js/users-app.js"></script>
    <!-- Initialize components before Alpine.js -->
    <script src="js/init-components.js"></script>
    <!-- Load Alpine.js last with defer -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100">
    <div x-data="unifiedApp()" x-init="init()" class="min-h-screen">
        <!-- Ban Notification -->
        <div x-show="banNotification && banNotification.show" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform -translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform -translate-y-2"
             class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md w-full px-4">
            <div :class="{'bg-red-600': banNotification && !banNotification.expired, 'bg-green-600': banNotification && banNotification.expired}" 
                 class="rounded-lg shadow-lg p-4 text-white">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i :class="{'fa-ban': banNotification && !banNotification.expired, 'fa-check-circle': banNotification && banNotification.expired}" 
                           class="fas text-2xl"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium whitespace-pre-line" x-text="banNotification ? banNotification.message : ''"></p>
                    </div>
                    <button @click="banNotification.show = false" 
                            class="ml-4 flex-shrink-0 inline-flex text-white hover:text-gray-200 focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Moderator Panel Navigation -->
        <div x-show="user && user.is_moderator" class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-800">Moderator Panel</h1>
                </div>
                <nav class="flex space-x-8 pb-3">
                    <button @click="activeTab = 'comments'" 
                            :class="activeTab === 'comments' ? 'text-gray-900 font-semibold border-b-2 border-blue-500' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors pb-3">Comments</button>
                    <button @click="activeTab = 'reports'" 
                            :class="activeTab === 'reports' ? 'text-gray-900 font-semibold border-b-2 border-blue-500' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors pb-3">
                        Reports
                        <span x-show="globalReports.length > 0" 
                              class="ml-1 bg-red-500 text-white px-2 py-0.5 rounded-full text-xs">
                            <span x-text="globalReports.length"></span>
                        </span>
                    </button>
                    <button @click="activeTab = 'moderators'" 
                            :class="activeTab === 'moderators' ? 'text-gray-900 font-semibold border-b-2 border-blue-500' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors pb-3">Moderators</button>
                    <button @click="activeTab = 'users'" 
                            :class="activeTab === 'users' ? 'text-gray-900 font-semibold border-b-2 border-blue-500' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors pb-3">Users</button>
                </nav>
            </div>
        </div>

        <!-- Main Content Container -->
        <div class="container mx-auto px-4 max-w-7xl mt-6">
            <!-- Comments View -->
            <div x-show="activeTab === 'comments'" class="max-w-4xl mx-auto">

                <!-- Header -->
                <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-4">
                    <h1 class="text-xl md:text-2xl font-bold mb-4">Comments</h1>
                    
                    <!-- Sign In / User Info -->
                    <div class="mb-4">
                        <div x-show="!user">
                            <button @click="signInWithDiscord()" 
                                    class="btn-primary mobile-btn bg-indigo-600 hover:bg-indigo-700 w-full sm:w-auto">
                                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.369-.444.85-.608 1.23a18.566 18.566 0 0 0-5.487 0 12.36 12.36 0 0 0-.617-1.23A.077.077 0 0 0 8.562 3c-1.714.29-3.354.8-4.885 1.491a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055 20.03 20.03 0 0 0 5.993 2.98.078.078 0 0 0 .084-.026 13.83 13.83 0 0 0 1.226-1.963.074.074 0 0 0-.041-.104 13.175 13.175 0 0 1-1.872-.878.075.075 0 0 1-.008-.125 10.775 10.775 0 0 0 .372-.291.072.072 0 0 1 .077-.01c3.927 1.764 8.18 1.764 12.061 0a.071.071 0 0 1 .078.009c.12.098.246.198.373.292a.075.075 0 0 1-.006.125c-.598.344-1.22.635-1.873.877a.075.075 0 0 0-.041.105c.36.687.772 1.341 1.225 1.962a.077.077 0 0 0 .084.028 19.963 19.963 0 0 0 6.002-2.981.076.076 0 0 0 .032-.054c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 0 0-.031-.028zM8.02 15.278c-1.182 0-2.157-1.069-2.157-2.38 0-1.312.956-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.956 2.38-2.157 2.38zm7.975 0c-1.183 0-2.157-1.069-2.157-2.38 0-1.312.955-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.946 2.38-2.157 2.38z"/>
                                </svg>
                                Sign in with Discord
                            </button>
                        </div>
                        
                        <div x-show="user">
                            <!-- User info -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <img :src="user?.avatar || ''" class="w-8 h-8 md:w-10 md:h-10 rounded-full mr-3">
                                    <span x-text="user?.username || ''" class="font-medium text-sm md:text-base"></span>
                                </div>
                                <button @click="signOut()" class="text-xs md:text-sm text-red-600 hover:text-red-800">
                                    Sign Out
                                </button>
                            </div>
                            
                            <!-- Comment box -->
                            <div class="space-y-3">
                                <textarea x-model="newCommentText" 
                                          @input="updatePreview()"
                                          :placeholder="user?.is_banned ? 'You are banned from commenting' : 'Write your comment... (Markdown supported)'"
                                          :disabled="user?.is_banned"
                                          class="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm disabled:bg-gray-100 disabled:cursor-not-allowed"
                                          rows="3"></textarea>
                                
                                <!-- Preview -->
                                <div x-show="newCommentText" class="mt-3">
                                    <h4 class="font-semibold mb-2 text-sm">Preview:</h4>
                                    <div x-html="commentPreview" class="markdown-content bg-gray-50 p-3 rounded-md"></div>
                                </div>
                                
                                <!-- Toolbar -->
                                <div class="flex justify-between items-center">
                                    <!-- Markdown buttons -->
                                    <div class="markdown-buttons">
                                        <button @click="insertMarkdown('**', '**')" title="Bold" class="markdown-btn">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button @click="insertMarkdown('*', '*')" title="Italic" class="markdown-btn">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button @click="insertMarkdown('~~', '~~')" title="Strikethrough" class="markdown-btn">
                                            <i class="fas fa-strikethrough"></i>
                                        </button>
                                        <button @click="insertMarkdown('## ', '')" title="Header" class="markdown-btn">
                                            <i class="fas fa-heading"></i>
                                        </button>
                                        <button @click="insertMarkdown('||', '||')" title="Spoiler" class="markdown-btn">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                        <button @click="insertImage()" title="Image" class="markdown-btn">
                                            <i class="fas fa-image"></i>
                                        </button>
                                        <button @click="insertVideo()" title="Video" class="markdown-btn">
                                            <i class="fas fa-video"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Post button -->
                                    <button @click="submitComment()" 
                                            :disabled="!newCommentText.trim() || user?.is_banned"
                                            class="btn-primary">
                                        Post Comment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sorting -->
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <button @click="sortBy = 'likes'; sortComments()" 
                                :class="{'bg-blue-500 text-white': sortBy === 'likes', 'bg-gray-200': sortBy !== 'likes'}"
                                class="sort-btn flex-shrink-0">
                            <i class="fas fa-thumbs-up mr-1"></i>Top
                        </button>
                        <button @click="sortBy = 'popularity'; sortComments()" 
                                :class="{'bg-blue-500 text-white': sortBy === 'popularity', 'bg-gray-200': sortBy !== 'popularity'}"
                                class="sort-btn flex-shrink-0">
                            <i class="fas fa-fire mr-1"></i>Popular
                        </button>
                        <button @click="sortBy = 'newest'; sortComments()" 
                                :class="{'bg-blue-500 text-white': sortBy === 'newest', 'bg-gray-200': sortBy !== 'newest'}"
                                class="sort-btn flex-shrink-0">
                            <i class="fas fa-clock mr-1"></i>Newest
                        </button>
                        <button @click="sortBy = 'oldest'; sortComments()" 
                                :class="{'bg-blue-500 text-white': sortBy === 'oldest', 'bg-gray-200': sortBy !== 'oldest'}"
                                class="sort-btn flex-shrink-0">
                            <i class="fas fa-history mr-1"></i>Oldest
                        </button>
                    </div>
                </div>

                <!-- Focus mode header -->
                <div x-show="focusedCommentId" class="bg-white rounded-lg shadow-md p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold">Viewing replies</h2>
                        <button @click="exitFocusMode()" class="btn-secondary text-sm">
                            <i class="fas fa-arrow-left mr-1"></i>
                            Back to discussion
                        </button>
                    </div>
                </div>
                
                <!-- Comments -->
                <div class="comment-thread">
                    <template x-for="comment in (focusedCommentId ? focusedComments : sortedComments)" :key="comment.id">
                        <div x-html="renderComment(comment, 0)"></div>
                    </template>
                </div>

                <!-- Loading -->
                <div x-show="loading" class="text-center py-8">
                    <div class="loading-spinner"></div>
                </div>

                <!-- Empty state -->
                <div x-show="!loading && comments.length === 0" class="text-center py-8 text-gray-500">
                    <i class="fas fa-comments text-4xl mb-4"></i>
                    <p class="text-sm">No comments yet. Be the first to comment!</p>
                </div>
            </div>

            <!-- Reports View -->
            <div x-show="activeTab === 'reports'" class="max-w-6xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-flag mr-2 text-red-600"></i>
                        Global Reports Dashboard
                    </h2>
                    
                    <div class="mb-4 flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                        <p class="text-gray-600 flex-shrink-0">
                            Showing <span class="font-semibold" x-text="filteredReports.length"></span> pending reports 
                            <span x-show="selectedPage && selectedPage !== currentPageId">(from page: <span class="font-semibold" x-text="selectedPage"></span>)</span>
                            <span x-show="!selectedPage">(from all pages)</span>
                            <span x-show="selectedPage === currentPageId">(from current page)</span>
                        </p>
                        <div class="flex flex-wrap gap-2 ml-auto">
                            <button @click="loadGlobalReports()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                            <div class="relative">
                                <button @click="showPageDropdown = !showPageDropdown" 
                                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md flex items-center">
                                    <i class="fas fa-filter mr-2"></i>
                                    <span x-text="getFilterButtonText()"></span>
                                    <i class="fas fa-chevron-down ml-2"></i>
                                </button>
                                <div x-show="showPageDropdown" 
                                     @click.away="showPageDropdown = false"
                                     x-transition
                                     class="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-md shadow-lg z-10">
                                    <div class="p-2">
                                        <input type="text" 
                                               x-model="pageSearchQuery"
                                               @input="filterPages()"
                                               placeholder="Search pages..." 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="max-h-60 overflow-y-auto">
                                        <button @click="selectPage(currentPageId)" 
                                                class="w-full text-left px-4 py-2 hover:bg-gray-100 border-b border-gray-200"
                                                :class="selectedPage === currentPageId ? 'bg-blue-50' : ''">
                                            <span class="font-medium">Current Page Only</span>
                                            <span class="text-sm text-gray-500 ml-2" x-text="`(${currentPageId})`"></span>
                                        </button>
                                        <button @click="selectPage(null)" 
                                                class="w-full text-left px-4 py-2 hover:bg-gray-100 border-b border-gray-200"
                                                :class="!selectedPage ? 'bg-blue-50' : ''">
                                            <span class="font-medium">All Pages</span>
                                        </button>
                                        <template x-for="page in filteredPages" :key="page.page_id">
                                            <button @click="selectPage(page.page_id)" 
                                                    class="w-full text-left px-4 py-2 hover:bg-gray-100 border-b border-gray-200">
                                                <div class="flex justify-between items-center">
                                                    <span x-text="page.page_id" class="font-medium"></span>
                                                    <span class="text-sm text-gray-500">(<span x-text="page.report_count"></span> report<span x-show="page.report_count != 1">s</span>)</span>
                                                </div>
                                            </button>
                                        </template>
                                        <div x-show="filteredPages.length === 0 && pageSearchQuery" 
                                             class="px-4 py-2 text-gray-500 text-center">
                                            No pages found
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading state -->
                    <div x-show="loadingReports" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                        <p class="mt-4 text-gray-600">Loading reports...</p>
                    </div>
                    
                    <!-- No reports -->
                    <div x-show="!loadingReports && filteredReports.length === 0" class="text-center py-8">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
                        <p class="text-gray-600">
                            <span x-show="selectedPage">No pending reports for page: <span class="font-semibold" x-text="selectedPage"></span></span>
                            <span x-show="!selectedPage">No pending reports</span>
                        </p>
                    </div>
                    
                    <!-- Reports list -->
                    <div x-show="!loadingReports && filteredReports.length > 0" class="space-y-4">
                        <template x-for="report in filteredReports" :key="report.id">
                            <div x-html="renderReportCard(report)"></div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Moderators View -->
            <div x-show="activeTab === 'moderators'" class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-shield-alt mr-2 text-blue-600"></i>
                        Moderator Management
                    </h2>
                    
                    <!-- Add moderator form -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">Add New Moderator</h3>
                        <div class="flex space-x-4">
                            <input type="text" 
                                   x-model="newModeratorId" 
                                   placeholder="Enter Discord User ID (e.g., discord_123456789)"
                                   class="flex-1 p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                            <button @click="addModerator()" 
                                    :disabled="!newModeratorId"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md disabled:bg-gray-300">
                                <i class="fas fa-plus mr-2"></i>Add Moderator
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current moderators list -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Current Moderators</h3>
                        
                        <div x-show="loadingModerators" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                        </div>
                        
                        <div x-show="!loadingModerators && moderators.length === 0" class="text-center py-8 text-gray-500">
                            No moderators found
                        </div>
                        
                        <div x-show="!loadingModerators && moderators.length > 0" class="space-y-3">
                            <template x-for="mod in moderators" :key="mod.id">
                                <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex items-center">
                                        <img :src="mod.picture || 'https://cdn.discordapp.com/embed/avatars/1.png'" 
                                             class="w-10 h-10 rounded-full mr-3">
                                        <div>
                                            <p class="font-medium" x-text="mod.name"></p>
                                            <p class="text-sm text-gray-600" x-text="mod.id"></p>
                                        </div>
                                    </div>
                                    <button @click="removeModerator(mod.id, mod.name)" 
                                            :disabled="mod.id === user.id"
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm disabled:bg-gray-300">
                                        <i class="fas fa-times mr-1"></i>Remove
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users View -->
            <div x-show="activeTab === 'users'" class="max-w-7xl mx-auto">
                <!-- Search Bar -->
                <div class="mb-6">
                    <div class="relative">
                        <input
                            type="text"
                            x-model="userSearchQuery"
                            @input="debouncedUserSearch()"
                            placeholder="Search users by name, email, or ID..."
                            class="w-full px-4 py-3 pl-10 pr-4 text-gray-700 bg-white border rounded-lg focus:outline-none focus:border-blue-500"
                        >
                        <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Users List -->
                <div class="space-y-4">
                    <template x-for="user in users" :key="user.id">
                        <div class="user-card">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4">
                                    <img :src="user.picture || 'https://via.placeholder.com/40'" 
                                         :alt="user.name" 
                                         class="w-12 h-12 rounded-full">
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <h3 class="font-semibold text-lg" x-text="user.name"></h3>
                                            <template x-if="user.is_moderator">
                                                <span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full">Moderator</span>
                                            </template>
                                            <template x-if="user.is_banned">
                                                <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">
                                                    <span x-text="user.current_ban_status === 'permanent' ? 'Permanently Banned' : 'Temporarily Banned'"></span>
                                                </span>
                                            </template>
                                        </div>
                                        <p class="text-sm text-gray-600" x-text="user.id"></p>
                                        <p class="text-sm text-gray-500" x-text="user.email"></p>
                                        
                                        <!-- User Stats -->
                                        <div class="mt-2 grid grid-cols-2 sm:grid-cols-5 gap-4 text-sm">
                                            <div>
                                                <span class="text-gray-500">Trust Score:</span>
                                                <span class="font-medium" :class="{
                                                    'text-green-600': user.trust_score >= 80,
                                                    'text-yellow-600': user.trust_score >= 50 && user.trust_score < 80,
                                                    'text-red-600': user.trust_score < 50
                                                }" x-text="user.trust_score || 100"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Comments:</span>
                                                <span class="font-medium" x-text="user.comment_count || 0"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Times Reported:</span>
                                                <span class="font-medium" x-text="user.times_reported || 0"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Reports Made:</span>
                                                <span class="font-medium" x-text="user.reports_made || 0"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-500">Ban Count:</span>
                                                <span class="font-medium" x-text="user.ban_count || 0"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex items-center space-x-2">
                                    <button
                                        @click="toggleUserDetails(user.id)"
                                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                        x-text="expandedUser === user.id ? 'Collapse' : 'Expand'"
                                    ></button>
                                    
                                    <!-- Ban Dropdown -->
                                    <div class="relative" x-data="{ open: false }">
                                        <button
                                            @click="open = !open"
                                            class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
                                            x-show="!user.is_banned"
                                        >
                                            Ban
                                        </button>
                                        <div
                                            x-show="open"
                                            @click.away="open = false"
                                            x-transition
                                            class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50"
                                        >
                                            <button @click="banUser(user.id, user.name, '30m'); open = false" 
                                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                Ban for 30 minutes
                                            </button>
                                            <button @click="banUser(user.id, user.name, '6h'); open = false" 
                                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                Ban for 6 hours
                                            </button>
                                            <button @click="banUser(user.id, user.name, '1d'); open = false" 
                                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                Ban for 1 day
                                            </button>
                                            <button @click="banUser(user.id, user.name, '7d'); open = false" 
                                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                Ban for 7 days
                                            </button>
                                            <button @click="banUser(user.id, user.name, 'permanent'); open = false" 
                                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                Permanent ban
                                            </button>
                                            <button @click="showCustomBanInput(user.id, user.name); open = false" 
                                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 border-t">
                                                Custom duration...
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button
                                        @click="warnUser(user.id, user.name)"
                                        class="px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700"
                                    >
                                        Warn
                                    </button>
                                    
                                    <button
                                        @click="toggleModerator(user.id, !user.is_moderator)"
                                        class="px-3 py-1 text-sm rounded"
                                        :class="user.is_moderator ? 'bg-gray-600 text-white hover:bg-gray-700' : 'bg-purple-600 text-white hover:bg-purple-700'"
                                        x-text="user.is_moderator ? 'Remove Mod' : 'Make Mod'"
                                    ></button>
                                </div>
                            </div>
                            
                            <!-- Expanded Details -->
                            <div x-show="expandedUser === user.id" x-transition class="mt-4 border-t pt-4">
                                <!-- History Sections -->
                                <div class="space-y-4">
                                    <!-- Ban History -->
                                    <div x-show="userHistory[user.id]?.banHistory?.length > 0">
                                        <h4 class="font-semibold text-gray-700 mb-2">Ban History</h4>
                                        <div class="space-y-2">
                                            <template x-for="ban in (userHistory[user.id]?.banHistory || [])" :key="ban.id">
                                                <div class="text-sm bg-gray-50 p-2 rounded">
                                                    <span class="font-medium" x-text="ban.action === 'ban' ? 'Banned' : 'Unbanned'"></span>
                                                    <span x-text="ban.duration || 'permanent'"></span>
                                                    by <span x-text="ban.performed_by_name"></span>
                                                    - <span x-text="getRelativeTime(ban.performed_at)"></span>
                                                    <span x-show="ban.reason" class="block text-gray-600" x-text="'Reason: ' + ban.reason"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- Reported History -->
                                    <div x-show="userHistory[user.id]?.reportedHistory?.length > 0">
                                        <h4 class="font-semibold text-gray-700 mb-2">Times Reported</h4>
                                        <div class="space-y-2">
                                            <template x-for="report in (userHistory[user.id]?.reportedHistory || [])" :key="report.id">
                                                <div class="text-sm bg-gray-50 p-2 rounded">
                                                    Reported by <span x-text="report.reporter_name"></span>
                                                    - <span x-text="getRelativeTime(report.reported_at)"></span>
                                                    <span class="ml-2 px-2 py-1 text-xs rounded" :class="{
                                                        'bg-green-100 text-green-800': report.status === 'resolved',
                                                        'bg-gray-100 text-gray-800': report.status === 'dismissed',
                                                        'bg-yellow-100 text-yellow-800': report.status === 'pending'
                                                    }" x-text="report.status"></span>
                                                    <span x-show="report.reason" class="block text-gray-600" x-text="'Reason: ' + report.reason"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- Report History -->
                                    <div x-show="userHistory[user.id]?.reportHistory?.length > 0">
                                        <h4 class="font-semibold text-gray-700 mb-2">Reports Made</h4>
                                        <div class="space-y-2">
                                            <template x-for="report in (userHistory[user.id]?.reportHistory || [])" :key="report.id">
                                                <div class="text-sm bg-gray-50 p-2 rounded">
                                                    Reported <span x-text="report.reported_user_name"></span>
                                                    - <span x-text="getRelativeTime(report.reported_at)"></span>
                                                    <span class="ml-2 px-2 py-1 text-xs rounded" :class="{
                                                        'bg-green-100 text-green-800': report.status === 'resolved',
                                                        'bg-gray-100 text-gray-800': report.status === 'dismissed',
                                                        'bg-yellow-100 text-yellow-800': report.status === 'pending'
                                                    }" x-text="report.status"></span>
                                                    <span x-show="report.reason" class="block text-gray-600" x-text="'Reason: ' + report.reason"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- Recent Comments -->
                                    <div>
                                        <h4 class="font-semibold text-gray-700 mb-2">Recent Comments</h4>
                                        <div x-show="!userComments[user.id]" class="text-sm text-gray-500">
                                            <button @click="loadUserComments(user.id)" class="text-blue-600 hover:underline">
                                                Load comments
                                            </button>
                                        </div>
                                        <div x-show="userComments[user.id]" class="space-y-2">
                                            <template x-for="comment in userComments[user.id]" :key="comment.id">
                                                <div x-html="renderComment(comment, 0)"></div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Pagination -->
                <div x-show="totalPages > 1" class="mt-6 flex justify-center">
                    <nav class="flex space-x-2">
                        <button
                            @click="changePage(currentPage - 1)"
                            :disabled="currentPage === 1"
                            class="px-3 py-2 text-sm bg-white border rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Previous
                        </button>
                        
                        <template x-for="page in visiblePages" :key="page">
                            <button
                                @click="changePage(page)"
                                :class="page === currentPage ? 'bg-blue-500 text-white' : 'bg-white hover:bg-gray-50'"
                                class="px-3 py-2 text-sm border rounded-md"
                                x-text="page"
                            ></button>
                        </template>
                        
                        <button
                            @click="changePage(currentPage + 1)"
                            :disabled="currentPage === totalPages"
                            class="px-3 py-2 text-sm bg-white border rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Next
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified App JavaScript -->
    <script>
    function unifiedApp() {
        // Get the original app instances
        const commentAppBase = commentApp();
        const reportsAppBase = reportsApp();
        const moderatorAppBase = moderatorApp();
        const usersAppBase = usersApp();
        
        return {
            // Include all comment app properties and methods
            ...commentAppBase,
            
            // Add unified state
            activeTab: 'comments',
            currentPageId: '',
            
            // Reports state
            globalReports: [],
            filteredReports: [],
            pages: [],
            filteredPages: [],
            selectedPage: null,
            showPageDropdown: false,
            pageSearchQuery: '',
            loadingReports: false,
            
            // Moderators state
            moderators: [],
            loadingModerators: false,
            newModeratorId: '',
            
            // Users state
            users: [],
            userHistory: {},
            userComments: {},
            expandedUser: null,
            userSearchQuery: '',
            currentPage: 1,
            totalPages: 1,
            totalUsers: 0,
            limit: 50,
            searchTimeout: null,
            
            async init() {
                // Set global instance
                window.unifiedAppInstance = this;
                window.commentAppInstance = this;
                
                // Get current page ID
                this.currentPageId = this.getPageId();
                
                // Initialize comment app
                await commentAppBase.init.call(this);
                
                // Load global reports if moderator
                if (this.user?.is_moderator) {
                    // Set default filter to current page
                    this.selectedPage = this.currentPageId;
                    await this.loadGlobalReports();
                    await this.loadModerators();
                    await this.loadUsers();
                }
            },
            
            // Reports methods
            async loadGlobalReports() {
                this.loadingReports = true;
                const sessionToken = localStorage.getItem('sessionToken');
                
                try {
                    const response = await fetch(`${this.apiUrl}/reports`, {
                        headers: { 
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (response.ok) {
                        this.globalReports = await response.json();
                        this.extractPagesFromReports();
                        
                        // Apply filter (default to current page)
                        if (this.selectedPage) {
                            this.filteredReports = this.globalReports.filter(r => r.page_id === this.selectedPage);
                        } else {
                            this.filteredReports = [...this.globalReports];
                        }
                        
                        // Load user history for each report
                        for (const report of this.filteredReports) {
                            await this.loadUserHistoryForReport(report);
                        }
                    }
                } catch (error) {
                    console.error('Error loading reports:', error);
                } finally {
                    this.loadingReports = false;
                }
            },
            
            extractPagesFromReports() {
                const pageMap = new Map();
                
                this.globalReports.forEach(report => {
                    if (!pageMap.has(report.page_id)) {
                        pageMap.set(report.page_id, {
                            page_id: report.page_id,
                            report_count: 0
                        });
                    }
                    pageMap.get(report.page_id).report_count++;
                });
                
                this.pages = Array.from(pageMap.values()).sort((a, b) => 
                    b.report_count - a.report_count
                );
                this.filteredPages = [...this.pages];
            },
            
            filterPages() {
                const query = this.pageSearchQuery.toLowerCase().trim();
                
                if (!query) {
                    this.filteredPages = [...this.pages];
                } else {
                    this.filteredPages = this.pages.filter(page => 
                        page.page_id.toLowerCase().includes(query)
                    );
                }
            },
            
            selectPage(pageId) {
                this.selectedPage = pageId;
                this.showPageDropdown = false;
                
                if (pageId) {
                    this.filteredReports = this.globalReports.filter(r => r.page_id === pageId);
                } else {
                    this.filteredReports = [...this.globalReports];
                }
            },
            
            async loadUserHistoryForReport(report) {
                try {
                    const sessionToken = localStorage.getItem('sessionToken');
                    const response = await fetch(`${this.apiUrl}/users/${report.comment_user_id}/history`, {
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const history = await response.json();
                        report.user_history = history;
                    }
                } catch (error) {
                    console.error('Error loading user history:', error);
                }
            },
            
            // Moderators methods
            async loadModerators() {
                this.loadingModerators = true;
                const sessionToken = localStorage.getItem('sessionToken');
                
                try {
                    const response = await fetch(`${this.apiUrl}/moderators`, {
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (response.ok) {
                        this.moderators = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading moderators:', error);
                } finally {
                    this.loadingModerators = false;
                }
            },
            
            async addModerator() {
                if (!this.newModeratorId.trim()) return;
                
                const sessionToken = localStorage.getItem('sessionToken');
                
                try {
                    const response = await fetch(`${this.apiUrl}/users/${this.newModeratorId}/moderator`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_moderator: true })
                    });
                    
                    if (response.ok) {
                        this.newModeratorId = '';
                        await this.loadModerators();
                        alert('Moderator added successfully');
                    } else {
                        const error = await response.text();
                        alert(`Failed to add moderator: ${error}`);
                    }
                } catch (error) {
                    console.error('Error adding moderator:', error);
                    alert('Network error. Please try again.');
                }
            },
            
            async removeModerator(userId, userName) {
                if (!confirm(`Remove moderator privileges from ${userName}?`)) return;
                
                const sessionToken = localStorage.getItem('sessionToken');
                
                try {
                    const response = await fetch(`${this.apiUrl}/users/${userId}/moderator`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_moderator: false })
                    });
                    
                    if (response.ok) {
                        await this.loadModerators();
                        alert('Moderator removed successfully');
                    } else {
                        const error = await response.text();
                        alert(`Failed to remove moderator: ${error}`);
                    }
                } catch (error) {
                    console.error('Error removing moderator:', error);
                    alert('Network error. Please try again.');
                }
            },
            
            // Users methods
            async loadUsers() {
                try {
                    const sessionToken = localStorage.getItem('sessionToken');
                    const params = new URLSearchParams({
                        page: this.currentPage,
                        limit: this.limit
                    });
                    
                    if (this.userSearchQuery) {
                        params.append('search', this.userSearchQuery);
                    }
                    
                    const response = await fetch(`${this.apiUrl}/users?${params}`, {
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to load users');
                    
                    const data = await response.json();
                    this.users = data.users;
                    this.totalUsers = data.total;
                    this.totalPages = Math.ceil(data.total / this.limit);
                    
                    // Load history for each user
                    for (const user of this.users) {
                        await this.loadUserHistory(user.id);
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                }
            },
            
            async loadUserHistory(userId) {
                try {
                    const sessionToken = localStorage.getItem('sessionToken');
                    const response = await fetch(`${this.apiUrl}/users/${userId}/history`, {
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to load user history');
                    
                    const history = await response.json();
                    this.userHistory[userId] = history;
                } catch (error) {
                    console.error('Error loading user history:', error);
                }
            },
            
            async loadUserComments(userId) {
                try {
                    const sessionToken = localStorage.getItem('sessionToken');
                    const response = await fetch(`${this.apiUrl}/comments/user/${userId}?limit=20`, {
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to load user comments');
                    
                    const comments = await response.json();
                    this.userComments[userId] = comments;
                } catch (error) {
                    console.error('Error loading user comments:', error);
                }
            },
            
            debouncedUserSearch() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.currentPage = 1;
                    this.loadUsers();
                }, 300);
            },
            
            async toggleUserDetails(userId) {
                if (this.expandedUser === userId) {
                    this.expandedUser = null;
                } else {
                    this.expandedUser = userId;
                    
                    // Load comments if not already loaded
                    if (!this.userComments[userId]) {
                        await this.loadUserComments(userId);
                    }
                }
            },
            
            changePage(page) {
                if (page < 1 || page > this.totalPages) return;
                this.currentPage = page;
                this.loadUsers();
            },
            
            get visiblePages() {
                const pages = [];
                const start = Math.max(1, this.currentPage - 2);
                const end = Math.min(this.totalPages, this.currentPage + 2);
                
                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }
                
                return pages;
            },
            
            async toggleModerator(userId, isModerator) {
                const action = isModerator ? 'grant' : 'revoke';
                if (!confirm(`${action} moderator privileges?`)) return;
                
                const sessionToken = localStorage.getItem('sessionToken');
                
                try {
                    const response = await fetch(`${this.apiUrl}/users/${userId}/moderator`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_moderator: isModerator })
                    });
                    
                    if (response.ok) {
                        await this.loadUsers();
                        if (isModerator) {
                            await this.loadModerators();
                        }
                        alert(`Moderator privileges ${action}ed successfully`);
                    } else {
                        const error = await response.text();
                        alert(`Failed to ${action} moderator: ${error}`);
                    }
                } catch (error) {
                    console.error(`Error ${action}ing moderator:`, error);
                    alert('Network error. Please try again.');
                }
            },
            
            async banUser(userId, userName, duration) {
                await window.BanHandler.banUser(userId, userName, duration);
                await this.loadUsers();
            },
            
            async warnUser(userId, userName) {
                await window.BanHandler.warnUser(userId, userName);
            },
            
            async showCustomBanInput(userId, userName) {
                await window.BanHandler.showCustomBanInput(userId, userName);
                await this.loadUsers();
            },
            
            // Override sign out to handle all tabs
            async signOut() {
                await Auth.signOut();
                this.user = null;
                this.comments = [];
                this.moderators = [];
                this.users = [];
                this.globalReports = [];
                window.location.reload();
            },
            
            // Helper method for filter button text
            getFilterButtonText() {
                if (!this.selectedPage) {
                    return 'All Pages';
                } else if (this.selectedPage === this.currentPageId) {
                    return 'Current Page';
                } else {
                    return this.selectedPage;
                }
            },
            
            // Add renderReportCard method
            renderReportCard(report) {
                return reportsAppBase.renderReportCard.call(this, report);
            },
            
            // Ensure we have other required methods from reports app
            toggleUserHistory(report) {
                report.showHistory = !report.showHistory;
            },
            
            async deleteComment(report) {
                if (!confirm('Delete this reported comment?')) return;
                
                const sessionToken = localStorage.getItem('sessionToken');
                
                try {
                    const response = await fetch(`${this.apiUrl}/comments/${report.comment_id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (response.ok) {
                        // Resolve the report
                        await fetch(`${this.apiUrl}/reports/${report.id}/resolve`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${sessionToken}`
                            },
                            body: JSON.stringify({ action: 'resolved' })
                        });
                        
                        // Update local state
                        this.globalReports = this.globalReports.filter(r => r.id !== report.id);
                        this.filteredReports = this.filteredReports.filter(r => r.id !== report.id);
                        this.extractPagesFromReports();
                        
                        alert('Comment deleted successfully');
                    }
                } catch (error) {
                    console.error('Error deleting comment:', error);
                    alert('Failed to delete comment');
                }
            },
            
            async dismissReport(reportId) {
                if (!confirm('Dismiss this report?')) return;
                
                const sessionToken = localStorage.getItem('sessionToken');
                
                try {
                    const response = await fetch(`${this.apiUrl}/reports/${reportId}/resolve`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionToken}`
                        },
                        body: JSON.stringify({ action: 'dismissed' })
                    });
                    
                    if (response.ok) {
                        this.globalReports = this.globalReports.filter(r => r.id !== reportId);
                        this.filteredReports = this.filteredReports.filter(r => r.id !== reportId);
                        this.extractPagesFromReports();
                        
                        alert('Report dismissed');
                    }
                } catch (error) {
                    console.error('Error dismissing report:', error);
                    alert('Failed to dismiss report');
                }
            },
            
            toggleBanDropdown(reportId, event) {
                this.showBanDropdown = window.BanHandler.toggleBanDropdown(this.showBanDropdown, reportId, event);
            },
            
            async banUserWithDuration(userId, userName, duration) {
                await window.BanHandler.banUser(userId, userName, duration);
                await this.loadGlobalReports();
            },
            
            async warnUser(userId, userName) {
                await window.BanHandler.warnUser(userId, userName);
            }
        };
    }
    </script>
</body>
</html>